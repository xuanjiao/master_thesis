\chapter{Approach}
% Describe the performed solution with all possible details. Define necessary parameters, inputs, outputs and context of use, possible problems and when they can be applied. 

% Remember to define necessary concepts before using them, building the text from easiest definitions (not depending on previous definitions) to complex definitions (depending on previous definitions).

% E.g: 
% \begin{itemize}
%	\item Lost Communication: a lost communication occurs when the conditions of the environment are not sufficient or the distance between sender and receiver is to hight to transmit information.
%	\item Wait until rescue: when the robot loses its communication, the pre-designed state machine will stop the motors to keep the actual position. Energy safe mode will be enabled, at the same time that a channel transceiver daemon will send SOS messages every T and wait for reply during T sec. 
%\end{itemize}
In our system there are multiple robots that must handle various tasks. For example, visiting given rooms. To tackle this problem, a communication efficient task allocation system is designed. 
This system allocate task according to system resources, including environment factors, robot status and task specifications. Once this information is attained, the task allocation system assign robot a set of task.

\begin{itemize}
	\item \textsl{Robot.} Each robot is responsible for moving in 2-dimensional physical space as well as gathering measurement result from sensors. It has a rechargeable battery, and its level drops as robot moves and rotates.
	\item \textsl{Tasks.} Each task requires one or more robots to traverse a path in the workspace and carry out certain actions\cite{Ivan2017}.
	\item \textsl{Environment.} In this project, all robots are considered moving in an office environment that contains a corridor along the central x-axis and 16 rooms located around the corridor. The environment factors, such as room locations and occupancy possibilities help task allocation.
\end{itemize}

\section{Architecture Design}

The architecture of the system consist of several parts: centralized pool, robot controller, navigation stack, charging station and system environment(Figure \ref{fig:system_architecture}). 
\begin{itemize}
	\item \textsl{Centralized Pool.} A centralized pool consist of several modules: multi-robot task allocation module, map information, database, execution and monitoring. The database and map information modules contain the environment information(Figure \ref{fig:database_er}). The execution and monitoring module interacts with robots. The multi-robot task allocation module allocate tasks to robots.
	\item \textsl{Robot Controller.} A robot controller contains several modules: local task queue, execution and robot action. The local task queue stores tasks that the robot needs to complete sequentially. The execution module receives commands from centralized pool and decides when and which task the robot should run. The robot action module run tasks in local task queue when receives decision from execute module and interacts with enviroment and its navigation stack.
	\item \textsl{Navigation stack.} The move\_base node provides a ROS interface for configuring, running, and interacting with the navigation stack on a robot. It makes robot move to desired positions using the navigation stack. Its advantages include optionally performing recovery behaviors when the robot perceives itself as stuck\cite{move_base_node}. 
\end{itemize} 

\begin{figure}[htbp]
	\centering
	\includegraphics[width = 0.9\textwidth]{content/images/ch3/architecture.drawio.png}
	\caption{System Architecture}
	\label{fig:system_architecture}
\end{figure}

\section{System Environment}
\label{sec:system_enviroment}
As is discussed in the previous section, the system environment is an office environment. The SLAM (Simultaneous Localization and Mapping) is a technique to draw a map by estimating current location in an arbitrary space \cite{slam}. Map (Figure \ref{fig:room_division}) is created by SLAM.

\paragraph{Important areas and coordinates:}
\begin{itemize}
	\item \textsl{Rooms.} The enviroment is divided into regions that represent rooms in the facility (Figure \ref{fig:room_division}). If the coordinates of a point are in a region, it can be judged that the point is located in the corresponding room.
	\item \textsl{Doors.} The positions of doors (Figure \ref{fig:positions_door_station}) are stored in database. There are used by a ROS door simulator node, which broadcasts positions and door status periodically. The broadcast messages are received and filtered by robots.
	\item \textsl{Charging Stations.} The positions of charging stations (Figure \ref{fig:positions_door_station}) are used by ROS charging station nodes. For details please refer to Section \ref{sec:charging_station}.
\end{itemize}

\begin{figure}[htbp]
	\centering
	\includegraphics[width = 0.9\textwidth]{content/images/ch3/room_division.png}
	\caption{Room division}
	\label{fig:room_division}
\end{figure}

\begin{figure}[htbp]
	\centering
	\includegraphics[width = 0.9\textwidth]{content/images/ch3/positions_door_station.png}
	\caption{Positions of Charging Stations (C1-C3) and Doors (D1-D17)}
	\label{fig:positions_door_station}
\end{figure}

\subsection{Enviroment Infomation}

IoT system should be adopted in the system enviroment, which can provide enough enviroment information that help multi-task-allocation system to make decisions. 
In the simulation, door sensor simulators (Section \ref{sec:sensor_simulatior}) are used to represent IoT system. The robots interact with sensors to gather enviroment information while moving in the enviroment and report those enviroment information to centralized pool.
The details about centralized pool stores and studies from enviroment information is discussed in section \ref{sec:task_allocation_procedure}.

\section{Tasks and Task Composition and Decomposition Senario}

\subsection{Task Specification}
Robots should execute tasks in order to achieve the overall system goals: gather information and environmental information continuously for a long time and allocate tasks to robots based on the environmental information.  Therefore, three task names are defined: ``gather enviroment information task'' asks a robot gathers enviroment information from sensors, ``execute task'' asks a robot moves to a point and  ``charging task'' asks robot to refill its battery at charging station.
The task specifications are stored in ``task table'' in database (Table \ref{tab:db_task_table}).
\begin{table}[htb]
\centering
\resizebox{\textwidth}{!}{
\begin{tabular}{|c|c|c|c|c|c|c|c|c|c|} 
\hline
Task ID & Task Type & Start Time & Target ID & Robot ID & Priority & Status & dependency & Finish Time  & Description \\
\hline
1 &  Charging task & 2020-06-01 9:00:00 & 18 & 1 & 5 & RanToCompletion & 0 & 2020-06-01 9:00:20 & Succeeded \\
\hline
2 &  Execute task & 2020-06-01 9:00:50 & 22 & 2 & 2 &RanToCompletion & 0 & 2020-06-01 9:01:20 & Succeeded \\
\hline
3 &  Gather environment information task & 2020-06-01 9:02:00 & 2 & 2 & 1 & Running & 0 & 2020-06-01 9:02:40 & Succeeded \\ [1ex] 
\hline
\end{tabular}}
\caption{Task Table in Database}
\label{tab:db_task_table}
\begin{itemize}
	\label{sec:task_table}
	\item \textsl{Column Task ID.} A unique task identification.
	\item \textsl{Column Task Name.} Tasks names are ``gather enviroment information task '', ``execute task'' or ``charging task''.
	\item \textsl{Column Start Time.} The start time refers to when the robot should move towards the target. A starting time is given when the task is created. This time can be a time in the future or empty (no time limit). 
	\item \textsl{Column Finish Time.} The default value is empty. When the centralized pool receives task result, this column will be updated to the time when the centralized pool received the result.
	\item \textsl{Column Target ID.} Targets include doors, points and charging stations. When a robot run a ``gather environment information task'', it moves to the front of a door and interact with a sensor in the door position without entering the door. 
	When robot run an ``execute task'', the robot moves to a given point ether in corridor or in the room. When robot run a ``charging task'', the robot moves to a charging station and interact with this charging station.
	\item \textsl{Column Robot ID.} A unique robot identification.
	\item \textsl{Column Priority.} Task priorities allow user to easily prioritize tasks to clearly plan what to do next. The ``charging tasks'' are given the highest priority of 5. The ``gather environment information tasks'' are given the lowest priority of 1. The ``execute tasks'' has priority between 2-4 in the ``created'' status. Once this task failed once, its priority will be increased by 1 until it exceeds the maximum and is marked as ``Failed'' (Figure \ref{fig:centralized_task_handle}).
	\item \textsl{Column Task Status.} Task status are ``Created'', ``Succeeded'', ``Failed'', ``To rerun'', ``Error''. The difference between task status is discussed in Section \ref{sec:task_allocation_procedure}
	\item \textsl{Column Dependency.} If task B has a dependency of task A, task A needs to be preceded by tasks B. Those dependent tasks should be composed in the centralized pool.
	\item \textsl{Column Description.} The describtion of a succedded task is ``succedded''.  The describtion of a failed task is its failure reason.
\end{itemize}
\end{table}


\subsection{Task Composition and Decomposition}
Tasks can be distinguished to ``simple tasks'' and ``Complex tasks''.  ``Simple tasks'' comprises a single action that can be performed by a single robot. A ``Complex tasks'' can be broken up or decomposed into multiple ``small tasks''. Those sub-tasks of a complex task need to be performed by the same robot.
In this project, the centralized poll not only can create ``simple tasks'' according to task specifications (Table \ref{tab:db_task_table}), but also can analyze the dependencies of ``simple tasks'' and form a dependency chain to compose ``complex tasks''. The robot (robot controller) can decompose a ``Complex task'' to ``simple tasks'' and execute ``small tasks'' according to their dependencies.

\section{Multi-robot Task Allocation Senario}
The multi-robot task allocation module in the architecture should perform multi-robot task allocation. 
The implementation of task allocation is shown in Section \ref{sec:task_allocation_procedure}. There are some general rules for multi-robot task allocation.


\begin{enumerate}
	\label{sec:task_allocation_rule}
	\item When the battery of robot belows 10\%, a charging task will be created.
	\item When the battery of robot aboves 10\%, firstly, ``simple exeucte tasks'' according to the task table in database are created. Secondly, ``complex execute tasks'' will be composed and one of them will be selcted and allocated to robot. To ensure consistency, a ``complex task'' composed by only one ``simple task'' is allowed. 
    \item If there are no ``execute tasks'' in database or after ``execute tasks allocation'', the cost of tasks exceeds the threshold, a ``gather environment task'' will be created.
\end{enumerate}

\subsection{Execute Task}
As discussed in Section \ref{sec:task_allocation_rule}, one of the ``complex execute tasks'' should be selected for requesting robot. In order to select an ``execute task'', the decision variables and Equation \ref{eq:large_execute_task_cost} are used to calculate the cost. The ``complex execute tasks'' with the lowest cost will be selected.

\begin{equation}
	\label{eq:large_execute_task_cost} 
	\begin{aligned}
	& \mbox{W: Weight } \\
	& \mbox{n: Number of doors} \\
	& \mbox{Cost}_{\mbox{Large execute task}} = \frac{W_{\mbox{battery}} \times \mbox{Battery consumtion}}{n} + W_{\mbox{waiting}} \times \mbox{waiting time} \\
	& + W_{\mbox{possibility}} \times \prod\limits_{i=1}^n \mbox{Door open possibility}  + W_{\mbox{priority}} \times \mbox{Priority}
	\end{aligned}
\end{equation}

\paragraph{Decision variables}
\begin{itemize}
\item \textsl{Task Priority.}  The priority is discussed Section \ref{sec:task_table}.
\item \textsl{Product of Door Open Possibility.} Because of the limitation of simulation, the door open possibilities are used to represent room occupancies. A door open possibility is based on the statistic of door measurement results in a specific time period of a working day. 
	The doors on trajectory (doors that the robot may pass through) can be obtained from the map information module.
	An example of ``measurement result'' table is shown in Table \ref{tab:db_measurement_result}, an example of ``open possibility'' table is shown in Table \ref{tab:db_open_possibilities}. 
\item \textsl{Waiting Time. } The waiting time is the difference between the current simulation time and start time of the first task to be executed. $T_{waiting} = T_{first\_task} - T_{now}$
\item \textsl{Battery Consumption.} The Battery Consumption is related to robot trajectory. For a Large ``execute task'' that contains n simple task, Equation \ref{eq:battery_consumption} can be used to calculate battery consumption. The centralized pool will send the task with the lowest cost to this robot.
\end{itemize}


\begin{equation}
\begin{aligned}
\label{eq:battery_consumption}
& \mbox{B:Battery consumption } \\
& \mbox{W: Weight } \\
& \mbox{m: Number of waypoint } \\
& \mbox{n: Number of simple task} \\
& B_{\mbox{complex task}} = \sum_{\mbox{task}_1}^{\mbox{task}_n} B_{\mbox{trajectory}} \\
& = \sum_{t = \mbox{task}_1}^{\mbox{task}_n} \sum_{\mbox{waypoint}_1}^{\mbox{waypoint}_m} [W_{\mbox{position}} \times \mbox{position variation}+W_{\mbox{angle}}  \times \mbox{angle variation}]\\
& = \sum_{t = \mbox{task}_1}^{\mbox{task}_n} \sum_{p = \mbox{waypoint}_1}^{\mbox{waypoint}_m} [ W_{\mbox{position}} \times \sqrt{(x_p-x_{p-1} )^2+(y_p-y_{p-1} )^2} \\
&   + W_{\mbox{angle}} \times 2 \times \arccos(w_p)] 
\end{aligned}
\end{equation}


\subsection{Environment Task}
As is discussed in section \ref{sec:task_allocation_rule}, once there are no suitable tasks in centralized pool, the task allocation module should create a ``gather environment information task'' to gather more measurement results and further more improve the accuracy of ``open possibilities'' table.
To create a ``gather environment information task'', Equation \ref{eq:door_cost} and following decision factors can help task allocation module to select the door.

\paragraph*{Decision variables}
\begin{itemize}
	\item \textsl{Door Last Update Time.} The latest timestamp when the door is measured.
	\item \textsl{Product of Door Open Possibility.}
	\item \textsl{Battery Consumption.} The battery consumption is related to the trajectory from robot to the door. Equation \ref{eq:battery_consumption} can be used to calculate battery consumption.
\end{itemize}

\begin{equation}
	\label{eq:door_cost}
	\begin{aligned}
	& \mbox{W: Weight } \\
	& \mbox{n: Number of doors on trajectory} \\	
	& \mbox{Cost}_{\mbox{door}} = \frac{W_{\mbox{battery}} \times \mbox{Battery consumtion}}{n} + W_{\mbox{time}} \times (T_{\mbox{last update}} - T_{\mbox{now}}) \\
	& + W_{\mbox{possibility}} \times \prod\limits_{i=1}^n \mbox{Door open possibility}
	\end{aligned}
\end{equation}

\subsection{Charging Task}
As is discussed in section \ref{sec:task_allocation_rule}, once a robot sends task request to the centralized pool, the centralized pool should figure out whether this robot need charging, if yes it should create a ``charging task'' for requesting robot. Since there are multiple charging station in the system environment (Figure \ref{fig:positions_door_station}), the centralized pool selects a charging station for this robot using the following decision variables.

\paragraph*{Decision variables}

\begin{itemize}
	\item \textsl{Remain Time.} It describes how long will a charging station be free. 
	\item \textsl{Battery Consumption.} Similar to ``execute task'' allocation, the battery consumption is related to the trajectory from robot to the charging station. Equation \ref{eq:battery_consumption} can be used to calculate battery consumption.
\end{itemize}
In conclusion, equation \ref{eq:charging_station_cost} can be used to calculate the cost of a charging station. The centralized pool will generate a ``charging task'' for requesting robot to charging station with the lowest cost.

\begin{equation}	
\label{eq:charging_station_cost}
\begin{aligned}
	& \mbox{W: Weight } \\
	& \mbox{Cost}_{\mbox{charging station}} = \frac{W_{\mbox{battery}} \times \mbox{battery consumtion}}{n} + W_{\mbox{time}} \times T_{\mbox{remain}}
\end{aligned}
\end{equation}

